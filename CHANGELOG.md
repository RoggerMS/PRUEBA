# Changelog

## [Unreleased]

- Permite acceder a perfiles de usuario mediante rutas `/@usuario` y reemplaza prefijos `/u/`.
- Evita errores de `toString` en `ProfileFeed` al manejar valores indefinidos en `formatNumber`.
- Normalize profile feed response to a posts array to prevent `filteredItems.map` runtime errors in `ProfileFeed`.
- Keep profile data in sync in the edit dialog by updating local state and resetting form values on open.
- Remove legacy `/perfil` route and update navigation to use `/{username}` paths.
- Redirect `/profile` to `/{username}` and open profiles in public view instead of edit mode.
- Evita errores de `toLocaleString` en `ProfileView` cuando los contadores de seguidores, seguidos o publicaciones no están definidos.
- Prevent users from following themselves in feed and marketplace interfaces.
- Resolve multiple React Hook dependency warnings in profile, follower, workspace, notification, and toast components to ensure consistent state updates.
- Replace pg-mem dependency in tests with an in-memory Set to simulate case-insensitive username uniqueness.
- Use const declarations for like and follow counts in API routes and ensure `useEffect` runs consistently on the search page.
- Show empty state with upload call-to-action on notes page and fix upload modal handling.
- Allow creating workspace blocks in development and enable canvas panning by fixing block creation handler, updating block rendering with zoom, and ignoring pointer events on the grid.
- Enable direct profile editing from `/<username>` with a "Vista pública" toggle and option to exit public view.
- Normalize usernames to lowercase on write, allow case-insensitive lookups, and redirect to the canonical username.
- Normalize emails to lowercase during registration and login to ensure account recognition after signing out.
- Add `/api/users/profile` to fetch the authenticated user profile with stats.
- Enforce case-insensitive username uniqueness at the database level with a `lower(username)` unique index and backfill.
- Make username lookups case-insensitive and normalize registration to lowercase to prevent profile access failures.

- Display real Crolars balance and recent transactions in sidebar and `/crolars` page using API data.
- Fix feed interactions: animate and persist fire reactions, expose full post menu actions, and handle comment errors gracefully.

- Allow feed posts without text by relaxing server validation while ensuring content or media is provided.
- Use logged-in user info for optimistic feed updates and assign a default avatar during registration for consistent profiles.
- Ensure notifications API works on PostgreSQL by aligning Prisma schema and adding migration for `notifications` table.
- Prevent intermittent 401 responses from pgAdmin by allowing dashboard stats requests without authentication.
- Add workspace stats API and align stats hook to avoid HTML error when loading pizarra statistics.
- Gracefully fall back to zeroed workspace stats when the stats endpoint fails so the workspace page doesn't stay loading.
- Add Dockerfile and documentation for running PostgreSQL locally with Docker.
- Fix workspace board rendering and block creation by aligning block types and dimensions between API and frontend.
- Pass canvas offset and zoom to workspace blocks so pizarra interactions update and display correctly.
- Restore workspace grid background by removing conflicting CSS positioning.
- Initialize default content and unique z-index when creating workspace blocks so new blocks render reliably.
- Provide board management API routes to update, delete and duplicate boards, enabling workspace configuration.
- Remove placeholder random values from workspace statistics and expose collaborator and shared board counts.
- Include board creator details in workspace board API responses so the owner appears in the collaborator manager.

- Align feed client with API pagination and add single post endpoint for local development.
- Improve feed post actions: link user names to profiles, move follow button beside author info, restore flame reaction, and add share handling.

- Add aria-label to interest removal button for better accessibility.

- Remove redundant Feed navigation item from sidebar and mobile menus.
- Return 501 responses from placeholder auth API routes to prevent hanging requests.
- Provide toast and loading components for events pages and coerce `page` and `limit` query parameters to numbers to avoid module resolution and validation errors.
- Add missing events components and helpers so the events pages build without module resolution errors.
- Default cart items to an empty array in `ShoppingCart` to prevent `reduce` on `undefined` errors when the cart is uninitialized.
- Handle marketplace product tags provided as arrays or comma-separated strings to prevent runtime errors in product detail and search.
- Fix undefined composer and redundant close button in feed; simplify quick action labels.
- Pass textarea value to composer text handler to prevent `match` and `trim` runtime errors.
- Remove unnecessary emojis from feed composer buttons and make the composer modal responsive on mobile and desktop.
- Fix duplicate default export in `CategoryFilter` component that caused Next.js build failures.
- Hide main sidebar on mobile screens so it only appears on desktop.
- Simplify feed layout by removing the left column, widening the timeline, adding a closable weekly challenge banner, and moving the user level card to the global sidebar.
- Guard media viewer against missing media to prevent undefined `type` errors when opening feed posts.

- Add user stats and trending topics API endpoints to resolve profile and feed 404 errors.
- Provide default and placeholder avatars to eliminate broken image requests.
- Handle profile loading failures gracefully and display an error message instead of an endless spinner.
- Add Jest and React Testing Library tests for notifications hook to ensure single load and EventSource instance.
- Wrap notifications API calls with a development debug fetch that counts usage.
- Add global error boundary to log errors and offer reload or home navigation.
- Guard club president access and details when data is missing to avoid runtime errors.
- Split feed store selectors to prevent infinite re-render loops.
- Correct missing Smile icon in Facebook-style composer.
- Reorganize project by moving useful modules out of legacy `src` directory, consolidating components, hooks, types, store, and utilities under root paths.
- Allow optional `includeActivity` parameter in `/api/clubs/my-clubs` to prevent validation failures when omitted.
- Normalize club tag data to handle strings and prevent `slice(...).map` runtime errors in club cards and detail views.
- Prevent redundant notification fetches and SSE reconnections by refining `useNotifications` dependencies.
- Maintain a stable notifications stream by storing the `EventSource` in a ref and avoiding duplicate connections.
- Send session cookies in SSE connections, allow credentials on the stream endpoint, and log detailed ready state errors to improve notification stream resiliency.
- Guard club rating display to avoid runtime errors when rating is missing.
- Align club page sort options with API parameters and compute pagination to prevent fetch errors.
- Redirect root `auth`, `admin`, and `profile` paths to their default pages to eliminate 404 errors.
- Fix unbalanced braces and missing imports in comments API, notes page, feed pages, and forum icons so `npm run build` and development server start successfully.
- Add `/notes/upload` route and convert upload form to modal to avoid duplicate "Subir Apunte" buttons.
- Wire "Ver" and "Descargar" actions in notes grid to open the viewer and download the first file.
- Move Cantuta university data to root data/ directory so `npm run build` succeeds.
- Fix TypeScript build errors across project.
- Redirect `/auth/signin` to `/auth/login` and update authentication routes.
- Resolve component import mismatches and add API rate limiting helpers.
- Fix clubs page component imports and streamline create workflow to prevent runtime errors.
- Correct Feed import in App.tsx to use named export.
- Fix NotificationCenter and gamification component imports to prevent invalid element type errors.
- Replace NotificationCenter context usage with dedicated hook to avoid runtime type errors.
- Move notification stream helpers to `src/lib/notificationStream.ts`.
- Remove unsupported fields from auth registration and welcome transaction.
- Align gamification leaderboard and achievement data with defined types.
- Guard optional marketplace product properties to avoid undefined access.
- Provide complete mock data for clubs, competitions, and marketplace pages and remove unsupported `useSearchParams` usage so `npm run build` succeeds.
- Categorize gamification notifications correctly to allow local builds.
- Add Feed page and navigation link in sidebar.
- Replace Notes viewer modal with previous implementation to support PDF and image preview.
- Correct footer links for Cookies, Privacy, Terms, and Support pages.
- Allow unauthenticated users to view public posts via the feed API.
- Fix missing default exports in marketplace components to prevent invalid element type errors.
- Import auth options from shared `@/lib/auth` in club management API route to resolve build-time export errors.
- Pass detailed cart items and use the named `ShoppingCart` export in the marketplace page to avoid `reduce` on undefined during prerendering.
- Resolve feed API route type mismatches and enum casing errors.
- Skip notification stream setup when unauthenticated to eliminate 401 errors.
- Gracefully return an empty feed when the database is unavailable.
- Show mock feed posts and composer in development when the feed service is offline.
- Render home page content instead of a blank screen and replace Next.js links with React Router links.
- Fix missing Feed route and update feed component links to use React Router so the social network is displayed correctly.
- Stub authentication routes and add a session endpoint to avoid 404 errors during development.
- Rename "Espacio Personal" navigation item to "Workspace" and fix related links.
- Wrap root layout with SessionProvider and improve workspace board loading to prevent endless "Cargando..." state.
- Move SessionProvider into client Providers and add development session fallback so workspace loads without RSC errors.
- Fetch profile feed posts from API, fix AchievementCard import, and enable publishing from user profiles.
- Centralize route protection with middleware, isolate auth layout, and add automated checks for public/private access.
- Replace default "U" avatar with generic user icon and direct unauthenticated profile clicks to login.
- Guard missing profile fields and handle empty interests to prevent runtime errors on the profile page.
- Restore inline profile editing on `/perfil` without redirecting to settings.
- Replace example profile page with API-driven version and align editor with `/settings`.
- Remove quick configuration card from profile page and centralize settings under `/settings`.
- Reintroduce achievements tab and dedicated pages at `/perfil/logros` and `/[username]/logros`.
- Correct camera icon alignment on profile avatar and banner.
- Replace missing Fire icon with FlameIcon and use proper NotificationToast import to resolve development runtime errors.
- Correct cantuta data import path to resolve build failures.
- Lazy-load profile editor component to improve profile page performance.

- **FIXED: Notification Service Errors**
  - Added missing `connect()`, `disconnect()`, and `requestNotificationPermission()` methods to `notificationService.ts`
  - Fixed TypeError: "notificationService.connect is not a function" in MainLayout
  - Migrated from WebSocket to Server-Sent Events (SSE) for real-time notifications due to Next.js compatibility
  - Updated `useWebSocketNotifications.ts` to use EventSource API instead of WebSocket
  - Updated `useNotifications.ts` to use SSE for real-time notification streaming
  - Fixed "Network error" issues by switching to `/api/notifications/stream` SSE endpoint
  - Improved error handling and reconnection logic for SSE connections
  - Enhanced notification service with user ID tracking and connection status management
  - Added browser notification permission handling and display functionality

